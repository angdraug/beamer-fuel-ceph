% Copyright (c) 2014  Mirantis, Inc.
%
%    Licensed under the Apache License, Version 2.0 (the "License"); you may
%    not use this file except in compliance with the License. You may obtain
%    a copy of the License at
%
%         http://www.apache.org/licenses/LICENSE-2.0
%
%    Unless required by applicable law or agreed to in writing, software
%    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
%    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
%    License for the specific language governing permissions and limitations
%    under the License.
%
\documentclass[hyperref=unicode,utf8,xcolor=pst]{beamer}
\usetheme{boxes}
\setbeamertemplate{navigation symbols}{}
%
\definecolor{mirantisred}{RGB}{211,48,26}
\setbeamercolor{titlelike}{fg=mirantisred}
\setbeamercolor{structure}{fg=mirantisred}
%
\usepackage[T2A]{fontenc}
%
\usepackage{graphicx}
\usepackage{fancyvrb}
%
\title{\fontsize{26}{0}\selectfont Ceph in Mirantis OpenStack}
\author{\vspace{-2.5mm}\includegraphics[height=5cm]{Vector_RGB_MirantisLogo}\\Dmitry Borodaenko}
\date{Mountain View, 2014}
%
\begin{document}

\begin{frame}
	\titlepage
\end{frame}

\begin{frame}
	\frametitle{The Plan}
	\begin{enumerate}
		\item What is Ceph?
		\item How does Ceph fit into OpenStack?
		\item What can you make Ceph do with Fuel?
		\item Gotchas and limitations
		\item Ceph architecture overview
		\item Storage architecture for OpenStack with Ceph
		\item Deploying Ceph with Mirantis OpenStack
		\item Operating Ceph backed OpenStack services
		\item Troubleshooting
		\item Resources
	\end{enumerate}
\end{frame}

\begin{frame}
	\setcounter{framenumber}{1}
	\frametitle{What is Ceph?}
	Ceph is a free clustered storage system that provides unified
	object, block, and file storage.

	\begin{description}
		\item[Object Storage] RADOS objects support
			snapshotting, replication, and consistency.
		\item[Block Storage] RBD block devices are thinly
			provisioned over RADOS objects and can be
			accessed by QEMU via librbd library.\\
			\includegraphics[height=2.5cm]{ceph-rbd}
		\item[File Storage] CephFS metadata servers (MDS)
			provide a POSIX-compliant overlay over RADOS.
	\end{description}
\end{frame}

\begin{frame}
	\frametitle{What is Mirantis OpenStack?}
	\begin{description}
		\item[OpenStack] is an open source cloud computing
			platform.\\
			\vspace{0.5ex}
			\includegraphics[height=2cm]{openstack-components}
		\item[Mirantis] ships hardened OpenStack packages and
			provides Fuel utility to simplify deployment of
			OpenStack.
		\item[Fuel] uses Cobbler, MCollective, and Puppet to
			discover nodes, provision OS, and setup
			OpenStack services.\\
			\vspace{0.5ex}
			\includegraphics[height=3.8cm]{fuel-components}
	\end{description}
\end{frame}

\begin{frame}
	\frametitle{How does Ceph fit into OpenStack?}
	\begin{columns}
		\column{.65\textwidth}
		RBD drivers for OpenStack make libvirt configure the
		QEMU interface to librbd.

		\vspace{2ex}
		Ceph benefits:
		\begin{itemize}
			\item Multi-node striping and redundancy for
				block storage (Cinder volumes and Nova
				ephemeral drives)
			\item Copy-on-write cloning of images to
				volumes and instances
			\item Unified storage pool for all types of
				storage (object, block, POSIX)
			\item Live migration of Ceph-backed instances
		\end{itemize}

		\column{.35\textwidth}
		\includegraphics[height=6.5cm]{ceph-rbd-openstack}
	\end{columns}

	\vspace{2ex}
	Ceph drawbacks: sensitive to clock drift, low block storage
	density (erasure coding announced for Firefly), unproven
	multi-site support (async replication first appeared in Emperor)
\end{frame}

\begin{frame}
	\frametitle{What has Fuel ever done for Ceph?}
	\begin{enumerate}
		\item Fuel deploys Ceph Monitors and OSDs on dedicated
			nodes or in combination with OpenStack
			components.\\
			\includegraphics[height=3.7cm]{openstack-nodes}
		\item Creates partitions for OSDs when nodes are
			provisioned.
		\item Creates separate RADOS pools and sets up Cephx
			authentication for Cinder, Glance, and Nova.
		\item Configures Cinder, Glance, and Nova to use RBD
			backend with the right pools and credentials.
		\item Deploys RADOS Gateway (S3 and Swift API frontend
			to Ceph) behind HAProxy on controller nodes.
	\end{enumerate}
\end{frame}

\begin{frame}
	\frametitle{What does it look like?}
	Select storage options $\Rightarrow$ assign roles to nodes $\Rightarrow$ allocate disks:\\
	\vspace{3ex}
	\makebox[\textwidth][c]{\includegraphics[width=1.18\textwidth]{fuel-ceph-screenshots}}
\end{frame}

\begin{frame}
	\frametitle{Things we've done}
	\begin{itemize}
		\item Set the right GPT type GUIDs on OSD and journal
			partitions for udev automount rules to work
		\item ceph-deploy: set up root SSH between Ceph nodes
		\item Basic Ceph settings: cephx, pool size, networks
		\item Cephx: ceph auth command line can't be split
		\item Rados Gateway: has to be the Inktank's build of
			FastCGI, UUID token format requires an infinite
			revocation interval
		\item Nova and Cinder: many little things to make live
			migrations and CoW work out of the box
	\end{itemize}
\end{frame}

\begin{frame}
	\frametitle{Live VM migration with Ceph}
	Native peer to peer migration between two libvirtd servers:\\
	\includegraphics[height=3cm]{libvirt-p2p-migration}
\end{frame}

\begin{frame}
	\frametitle{Things we didn't get around to}
	\begin{itemize}
		\item Non-root user with sudo for ceph-deploy
		\item Calculate PG numbers based on the number of OSDs
		\item Ceph public network should go to a second storage
			network instead of management
		\item Dedicated Monitor nodes, list all Monitors in
			ceph.conf on each Ceph node
		\item Multi-backend configuration for Cinder
		\item A better way to configure pools for OpenStack
			services (than CEPH\_ARGS in the init script)
		\item Make Nova update VM's VNC listen address to
			vncserver\_listen of the destination compute
			after migration
		\item Replace 'qemu-img convert' with clone\_image in
			LibvirtDriver.snapshot() in Nova
	\end{itemize}
\end{frame}

\begin{frame}
	\frametitle{Diagnostics and troubleshooting}
	\begin{description}
		\item['ceph-deploy config pull' failed] -- check if the
			node can SSH to the primary controller
		\item[HEALTH\_WARN: clock skew detected] -- check your
			ntpd settings, make sure your NTP server is
			reachable from all nodes
	\end{description}
\end{frame}

\begin{frame}
	\frametitle{Resources}
	http://ceph.com/docs/next/rbd/rbd-openstack/\\
	https://bugs.launchpad.net/nova/+bug/1226351\\
	https://github.com/jdurgin/nova/commits/havana-ephemeral-rbd\\
	http://libvirt.org/migration.html\\
	https://bugs.launchpad.net/nova/+bug/1262450\\
	https://bugs.launchpad.net/nova/+bug/1262914\\
	http://mirantis.hs-sites.com/how-to-stop-worrying-about-storage-openstack-ceph-webcast\\
\end{frame}

\end{document}
